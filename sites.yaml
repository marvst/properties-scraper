# Procrawl Sites Configuration
# See sites.example.yaml for full documentation and more examples.

defaults:
  browser:
    browser_type: chromium
    headless: true
    verbose: false

  timing:
    page_timeout: 60000
    delay_before_return_html: 0

sites:
  - name: "apolar_apartments"
    enabled: true
    url: "https://www.apolar.com.br/alugar/apartamento/curitiba/2-quartos?mensal&country=Brasil&property_type=Apartamento&property_type=Casa&property_type=Sobrado&garage=1&price_max=R%24%203.100,00&area_min=50,00%20m%C2%B2&include_condominium_price=true"

    browser:
      browser_type: "chromium"
      headless: true
      verbose: true

    extraction:
      type: "css"
      css:
        base_selector: ".property-component"
        fields:
          - name: "property_type"
            selector: ".property-type"
            type: "text"
          - name: "street"
            selector: ".property-street"
            type: "text"
          - name: "address_others"
            selector: ".property-address-others"
            type: "text"
          - name: "garages_text"
            selector: ".feature.car"
            type: "text"
          - name: "bedrooms_text"
            selector: ".feature.bed"
            type: "text"
          - name: "area_text"
            selector: ".feature.ruler"
            type: "text"
          - name: "bathrooms_text"
            selector: ".feature.bw"
            type: "text"
          - name: "rent_price_text"
            selector: ".property-current-price"
            type: "text"
          - name: "condo_fee_text"
            selector: ".property-codominum-price"
            type: "text"
          - name: "property_url"
            selector: "a.info-area-wrapper"
            type: "attribute"
            attribute: "href"
          - name: "image_urls"
            selector: ".slick-slide:not(.slick-cloned) img"
            type: "attribute"
            attribute: "src"
            multiple: true

    interaction:
      css_selector: "[class^='property-component']"
      wait_for: |
        js:() => {
          return window.allButtonsClicked === true;
        }
      js_code: |
        (async () => {
          console.log("Starting sequential load-more button clicking...");

          const waitForPropertyContainer = () => {
            return new Promise(resolve => {
              const check = setInterval(() => {
                if (document.querySelector('.property-component')) {
                  clearInterval(check);
                  resolve();
                }
              }, 200);
            });
          };

          await waitForPropertyContainer();
          console.log('.property-container found. Starting sequential clicks.');

          let clickCount = 0;
          while (true) {
            const btn = document.querySelector('.load-more');
            if (!btn) {
              console.log(`No more .load-more buttons found after ${clickCount} clicks.`);
              break;
            }

            console.log(`Clicking load-more button #${clickCount + 1}...`);
            btn.click();
            clickCount++;

            await new Promise(resolve => setTimeout(resolve, 2000));
          }

          await new Promise(resolve => setTimeout(resolve, 3000));

          const propertyCount = document.querySelectorAll('[class^="property-component"]').length;
          console.log(`Total properties found in DOM: ${propertyCount}`);

          window.propertyCount = propertyCount;
          window.allButtonsClicked = true;
          console.log('All load-more buttons clicked. Ready for extraction.');
        })();

    timing:
      page_timeout: 120000
      # Note: delay_before_return_html causes hang when used with wait_for

    cache:
      mode: "bypass"

    data:
      required_keys:
        - "full_address"
        - "rent_price_brl"
      unique_key_fields:
        - "full_address"
        - "rent_price_brl"
        - "area_sqft"
      output_file: "apolar_results.csv"
      json_output_file: "apolar_extracted.json"

    transform:
      enabled: false

    details_scraping:
      enabled: true  # Set to true when selectors are configured
      max_concurrent_requests: 2
      request_delay_ms: 2000
      timeout_per_property: 30000
      wait_for: "css:.slick-slide"
      image_selectors:
        - ".slick-slide:not(.slick-cloned) img"
        - ".slick-slider img"
      image_attributes:
        - "src"
        - "data-lazy"
        - "data-src"
      extraction:
        type: "css"
        css:
          base_selector: "body"
          fields:
            - name: "additional_images"
              selector: ".slick-slide:not(.slick-cloned) img"
              type: "attribute"
              attribute: "src"
              multiple: true
  - name: "galvao_apartments"
    enabled: true
    url: "https://www.galvao.com.br/imoveis/apartamento-locacao-curitiba-agua-verde-2-ou-mais-quartos-1-ou-mais-vagas-ate-3100-de-50m2"
    base_url: "https://www.galvao.com.br"

    browser:
      browser_type: "chromium"
      headless: false
      verbose: true

    pagination:
      enabled: true
      start_page: 1
      max_pages: null  # Scrape all pages until no results
      page_template: "-pagina-{page}"

    extraction:
      type: "css"
      css:
        base_selector: ".list__card"
        fields:
          - name: "property_type"
            selector: ".list__type"
            type: "text"
          - name: "reference"
            selector: ".list__reference"
            type: "text"
          - name: "address_city"
            selector: ".list__address:nth-of-type(1)"
            type: "text"
          - name: "address_neighborhood"
            selector: ".list__address:nth-of-type(2)"
            type: "text"
          - name: "address_street"
            selector: ".list__address:nth-of-type(3)"
            type: "text"
          - name: "rent_price_text"
            selector: ".list__price"
            type: "text"
          - name: "area_text"
            selector: ".list__feature .list__item:nth-child(1)"
            type: "text"
          - name: "bedrooms_text"
            selector: ".list__feature .list__item:nth-child(2)"
            type: "text"
          - name: "bathrooms_text"
            selector: ".list__feature .list__item:nth-child(3)"
            type: "text"
          - name: "garages_text"
            selector: ".list__feature .list__item:nth-child(4)"
            type: "text"
          - name: "property_url"
            selector: "a.list__link"
            type: "attribute"
            attribute: "href"
          - name: "image_urls"
            selector: "img.list__img"
            type: "attribute"
            attribute: "src"
            multiple: true

    interaction:
      css_selector: ".list__card"
      wait_for: "css:.list__card"

    timing:
      page_timeout: 60000
      # delay_before_return_html: 2000

    cache:
      mode: "bypass"

    data:
      required_keys:
        - "property_url"
        - "rent_price_brl"
      unique_key_fields:
        - "full_address"
        - "rent_price_brl"
        - "area_sqft"
      output_file: "galvao_results.csv"
      json_output_file: "galvao_extracted.json"

    transform:
      enabled: false

    details_scraping:
      enabled: true
      max_concurrent_requests: 2
      request_delay_ms: 2000
      timeout_per_property: 30000
      wait_for: "css:.card__photo-img"
      image_selectors:
        - ".card__photo-img"
        - ".jetslider__item img"
      image_attributes:
        - "src"
      extraction:
        type: "llm"
        llm:
          provider: "openrouter/openai/gpt-4o-mini"
          input_format: "markdown"
          instruction: |
            Extract the following property information as JSON:
            {
              "full_address": "complete address with street, number, neighborhood, city, state",
              "condo_fee_text": "monthly condo/condominium fee (Condomínio) as shown, e.g. 'R$ 455,00'",
              "iptu_text": "IPTU property tax as shown, e.g. 'R$ 69,00'",
              "fire_insurance_text": "fire insurance (Seguro incêndio) as shown, e.g. 'R$ 40,00'",
              "total_monthly_cost_text": "total monthly cost as shown",
              "full_description": "full property description text",
              "amenities": ["list", "of", "amenities", "and", "features"],
              "total_area_text": "total area in m²",
              "private_area_text": "private area in m²"
            }
            Return only the JSON object, no explanation.